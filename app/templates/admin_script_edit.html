{% extends "base.html" %}

{% block title %}스크립트 편집 - HappyCall{% endblock %}

{% block content %}
<!-- 관리자 네비게이션 -->
<div class="flex flex-wrap gap-2 mb-6">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-chart-bar text-[10px]"></i>제출 현황
    </a>
    <a href="{{ url_for('admin.manage_customers') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-users text-[10px]"></i>고객 관리
    </a>
    <a href="{{ url_for('admin.edit_script') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-gray-900 text-white shadow-md">
        <i class="fas fa-file-lines text-[10px]"></i>스크립트 편집
    </a>
    <a href="{{ url_for('admin.manage_freelancers') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-user-plus text-[10px]"></i>프리랜서 관리
    </a>
</div>

<!-- 헤더 -->
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">스크립트 편집</h1>
    <p class="text-sm text-gray-500 mt-1">해피콜 스크립트를 수정하세요. 변수는 <code class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs font-mono">[변수명]</code> 형식으로 사용됩니다.</p>
</div>

<form method="POST" action="{{ url_for('admin.save_script') }}">
    <div class="grid lg:grid-cols-4 gap-6">
        <!-- 편집 영역 -->
        <div class="lg:col-span-3">
            <div class="glass rounded-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-surface-100 flex items-center justify-between">
                    <input type="text" name="title" value="{{ script.title if script else '기본 해피콜 스크립트' }}"
                        class="font-semibold text-gray-900 text-sm bg-transparent border-0 focus:outline-none focus:ring-0 w-full"
                        placeholder="스크립트 제목">
                    <button type="submit" class="btn-primary text-white font-semibold px-5 py-2 rounded-xl text-sm flex-shrink-0 ml-4">
                        <i class="fas fa-save mr-1.5"></i>저장
                    </button>
                </div>
                <div class="p-4">
                    <textarea name="content" id="script-editor" rows="30"
                        class="w-full px-4 py-3 bg-surface-50 border border-surface-200 rounded-xl text-sm text-gray-700 font-mono leading-relaxed focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all resize-y"
                        placeholder="스크립트 HTML을 입력하세요...">{{ script.content if script else '' }}</textarea>
                </div>
            </div>

            <!-- 미리보기 -->
            <div class="glass rounded-2xl overflow-hidden mt-6">
                <div class="px-6 py-4 border-b border-surface-100 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900 text-sm flex items-center gap-2">
                        <i class="fas fa-eye text-brand-500 text-xs"></i>미리보기
                    </h2>
                    <button type="button" id="refresh-preview-btn" class="text-xs text-brand-600 hover:text-brand-700 font-semibold">
                        <i class="fas fa-rotate mr-1"></i>새로고침
                    </button>
                </div>
                <div class="p-5">
                    <div id="script-preview" class="bg-blue-50/50 rounded-xl p-5 border border-blue-100/50">
                        <div class="text-sm text-gray-700 space-y-4" id="preview-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 변수 참조 패널 -->
        <div class="lg:col-span-1">
            <div class="glass rounded-2xl p-5 sticky top-24">
                <h2 class="font-semibold text-gray-900 text-sm mb-4 flex items-center gap-2">
                    <i class="fas fa-code text-brand-500 text-xs"></i>변수 목록
                </h2>
                <p class="text-xs text-gray-400 mb-3">클릭하면 에디터에 삽입됩니다</p>
                <div class="space-y-2">
                    {% for var, desc in variables %}
                    <button type="button" class="var-tag w-full text-left px-3 py-2 bg-surface-50 hover:bg-brand-50 border border-surface-200 hover:border-brand-200 rounded-lg transition-all group"
                            data-var="{{ var }}">
                        <span class="text-xs font-mono font-semibold text-brand-600 group-hover:text-brand-700">{{ var }}</span>
                        <p class="text-[10px] text-gray-400 mt-0.5">{{ desc }}</p>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('script-editor');
    const previewContent = document.getElementById('preview-content');
    const refreshBtn = document.getElementById('refresh-preview-btn');

    function updatePreview() {
        previewContent.innerHTML = editor.value;
    }

    refreshBtn.addEventListener('click', updatePreview);
    updatePreview();

    // 변수 태그 클릭 시 에디터에 삽입
    document.querySelectorAll('.var-tag').forEach(function(tag) {
        tag.addEventListener('click', function() {
            var varText = this.dataset.var;
            var start = editor.selectionStart;
            var end = editor.selectionEnd;
            var text = editor.value;
            editor.value = text.substring(0, start) + varText + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + varText.length;
            editor.focus();
        });
    });
});
</script>
{% endblock %}
