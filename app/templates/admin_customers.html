{% extends "base.html" %}

{% block title %}고객 관리 - HappyCall{% endblock %}

{% block content %}
<!-- 관리자 네비게이션 -->
<div class="flex flex-wrap gap-2 mb-6">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-chart-bar text-[10px]"></i>제출 현황
    </a>
    <a href="{{ url_for('admin.manage_customers') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-gray-900 text-white shadow-md">
        <i class="fas fa-users text-[10px]"></i>고객 관리
    </a>
    <a href="{{ url_for('admin.edit_script') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-file-lines text-[10px]"></i>스크립트 편집
    </a>
    <a href="{{ url_for('admin.manage_freelancers') }}" class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all bg-surface-100 text-gray-500 hover:bg-surface-200">
        <i class="fas fa-user-plus text-[10px]"></i>프리랜서 관리
    </a>
</div>

<!-- 헤더 -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">고객 관리</h1>
        <p class="text-sm text-gray-500 mt-1">고객을 조회하고 프리랜서에게 배정하세요</p>
    </div>
    <!-- 고객 추가 버튼 -->
    <button type="button" id="toggle-add-form" class="btn-primary text-white font-semibold px-4 py-2.5 rounded-xl text-sm">
        <i class="fas fa-plus mr-1.5"></i>고객 추가
    </button>
</div>

<!-- 고객 추가 폼 (숨김) -->
<div id="add-customer-form" class="hidden glass rounded-2xl p-5 mb-6">
    <form method="POST" action="{{ url_for('admin.create_customer') }}" class="flex flex-wrap items-end gap-4">
        <div class="flex-1 min-w-[200px]">
            <label class="text-xs font-semibold text-gray-600 mb-1.5 block">고객명</label>
            <input type="text" name="name" required placeholder="이름"
                class="w-full px-3.5 py-2.5 bg-white border border-surface-200 rounded-xl text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all">
        </div>
        <div class="flex-1 min-w-[200px]">
            <label class="text-xs font-semibold text-gray-600 mb-1.5 block">연락처</label>
            <input type="text" name="phone" required placeholder="010-0000-0000"
                class="w-full px-3.5 py-2.5 bg-white border border-surface-200 rounded-xl text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all">
        </div>
        <button type="submit" class="btn-success text-white font-semibold px-5 py-2.5 rounded-xl text-sm">
            <i class="fas fa-check mr-1.5"></i>추가
        </button>
    </form>
</div>

<!-- 상태 필터 버튼 -->
<div class="flex flex-wrap gap-2 mb-6">
    {% set status_filters = [
        ('all', '전체', 'fa-list', ''),
        ('대기', '대기', 'fa-clock', 'gray'),
        ('1차부재', '1차부재', 'fa-phone-slash', 'orange'),
        ('2차부재', '2차부재', 'fa-phone-slash', 'orange'),
        ('3차부재', '3차부재', 'fa-phone-slash', 'red'),
        ('통화거부', '통화거부', 'fa-ban', 'red'),
        ('해피콜완료', '해피콜완료', 'fa-check-circle', 'brand')
    ] %}
    {% for key, label, icon, color in status_filters %}
    <a href="{{ url_for('admin.manage_customers', status=key) }}"
       class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold transition-all
       {% if status_filter == key %}
           {% if color == 'red' %}bg-red-500 text-white shadow-md shadow-red-500/20
           {% elif color == 'orange' %}bg-orange-500 text-white shadow-md shadow-orange-500/20
           {% elif color == 'brand' %}bg-brand-500 text-white shadow-md shadow-brand-500/20
           {% else %}bg-gray-900 text-white shadow-md{% endif %}
       {% else %}bg-surface-100 text-gray-500 hover:bg-surface-200{% endif %}">
        <i class="fas {{ icon }} text-[10px]"></i>{{ label }}
        <span class="ml-1 opacity-70">{{ status_counts.get(key, 0) }}</span>
    </a>
    {% endfor %}
</div>

<!-- 일괄 배정 바 -->
<div id="bulk-bar" class="hidden glass rounded-2xl p-4 mb-4 flex flex-wrap items-center gap-4">
    <span class="text-sm font-medium text-gray-700">
        <span id="selected-count">0</span>건 선택
    </span>
    <form method="POST" action="{{ url_for('admin.bulk_assign_customers') }}" id="bulk-form" class="flex items-center gap-3 flex-1">
        <div id="bulk-ids-container"></div>
        <select name="bulk_agent_id" class="px-3 py-2 bg-white border border-surface-200 rounded-xl text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all">
            <option value="">배정 해제</option>
            {% for f in freelancers %}
            <option value="{{ f.id }}">{{ f.username }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn-primary text-white font-semibold px-4 py-2 rounded-xl text-sm">
            <i class="fas fa-paper-plane mr-1"></i>일괄 배정
        </button>
    </form>
</div>

<!-- 고객 테이블 -->
<div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-surface-200">
                    <th class="px-5 py-3 text-left w-10">
                        <input type="checkbox" id="select-all" class="rounded border-surface-300 text-brand-600 focus:ring-brand-500">
                    </th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">고객</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider hidden sm:table-cell">연락처</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">콜 상태</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">담당자</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider hidden md:table-cell">등록일</th>
                    <th class="px-5 py-3 text-right text-xs font-semibold text-gray-400 uppercase tracking-wider">배정</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-surface-100">
                {% for customer in customers %}
                <tr class="hover:bg-surface-50/50 transition-colors">
                    <td class="px-5 py-4">
                        <input type="checkbox" class="customer-check rounded border-surface-300 text-brand-600 focus:ring-brand-500" data-id="{{ customer.id }}">
                    </td>
                    <td class="px-5 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-white font-bold text-xs">
                                {{ customer.name[:1] }}
                            </div>
                            <span class="font-medium text-gray-900">{{ customer.name }}</span>
                        </div>
                    </td>
                    <td class="px-5 py-4 text-gray-500 hidden sm:table-cell">{{ customer.phone }}</td>
                    <td class="px-5 py-4">
                        {% set status_styles = {
                            '대기': 'bg-gray-100 text-gray-600',
                            '1차부재': 'bg-orange-100 text-orange-700',
                            '2차부재': 'bg-orange-100 text-orange-700',
                            '3차부재': 'bg-red-100 text-red-700',
                            '통화거부': 'bg-red-100 text-red-700',
                            '해피콜완료': 'status-normal'
                        } %}
                        <span class="{{ status_styles.get(customer.call_status, 'bg-gray-100 text-gray-600') }} px-2.5 py-1 rounded-lg text-xs font-semibold">
                            {{ customer.call_status }}
                        </span>
                    </td>
                    <td class="px-5 py-4">
                        {% if customer.assigned_agent %}
                        <span class="text-sm font-medium text-brand-600">{{ customer.assigned_agent.username }}</span>
                        {% else %}
                        <span class="text-xs text-gray-400">미배정</span>
                        {% endif %}
                    </td>
                    <td class="px-5 py-4 text-gray-400 text-xs hidden md:table-cell">{{ customer.created_at.strftime('%Y-%m-%d') }}</td>
                    <td class="px-5 py-4 text-right">
                        <form method="POST" action="{{ url_for('admin.assign_customer') }}" class="inline-flex items-center gap-2">
                            <input type="hidden" name="customer_id" value="{{ customer.id }}">
                            <select name="agent_id" class="px-2 py-1.5 bg-white border border-surface-200 rounded-lg text-xs text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400">
                                <option value="">해제</option>
                                {% for f in freelancers %}
                                <option value="{{ f.id }}" {% if customer.assigned_agent_id == f.id %}selected{% endif %}>{{ f.username }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="text-xs text-brand-600 hover:text-brand-700 font-semibold px-2 py-1 rounded-lg hover:bg-brand-50 transition-colors">
                                적용
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not customers %}
    <div class="p-16 text-center">
        <div class="w-16 h-16 rounded-2xl bg-surface-100 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-inbox text-2xl text-gray-300"></i>
        </div>
        <p class="text-gray-500 font-medium">등록된 고객이 없습니다</p>
        <p class="text-xs text-gray-400 mt-1">상단의 "고객 추가" 버튼으로 고객을 등록하세요</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 고객 추가 폼 토글
    var toggleBtn = document.getElementById('toggle-add-form');
    var addForm = document.getElementById('add-customer-form');
    toggleBtn.addEventListener('click', function() {
        addForm.classList.toggle('hidden');
    });

    // 체크박스 로직
    var selectAll = document.getElementById('select-all');
    var checks = document.querySelectorAll('.customer-check');
    var bulkBar = document.getElementById('bulk-bar');
    var selectedCount = document.getElementById('selected-count');
    var bulkIdsContainer = document.getElementById('bulk-ids-container');

    function updateBulkBar() {
        var checked = document.querySelectorAll('.customer-check:checked');
        if (checked.length > 0) {
            bulkBar.classList.remove('hidden');
            selectedCount.textContent = checked.length;
            bulkIdsContainer.innerHTML = '';
            checked.forEach(function(c) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'customer_ids';
                input.value = c.dataset.id;
                bulkIdsContainer.appendChild(input);
            });
        } else {
            bulkBar.classList.add('hidden');
        }
    }

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checks.forEach(function(c) { c.checked = selectAll.checked; });
            updateBulkBar();
        });
    }
    checks.forEach(function(c) {
        c.addEventListener('change', updateBulkBar);
    });
});
</script>
{% endblock %}
